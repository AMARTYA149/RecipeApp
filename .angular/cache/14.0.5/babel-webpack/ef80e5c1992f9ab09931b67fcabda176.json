{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getCacheOptions = exports.setupUniversal = void 0;\n\nconst common_1 = require(\"@nestjs/common\");\n\nconst express_engine_1 = require(\"@nguniversal/express-engine\");\n\nconst express = require(\"express\");\n\nconst cache_key_by_original_url_generator_1 = require(\"../cache/cache-key-by-original-url.generator\");\n\nconst in_memory_cache_storage_1 = require(\"../cache/in-memory-cache.storage\");\n\nconst DEFAULT_CACHE_EXPIRATION_TIME = 60000;\nconst logger = new common_1.Logger('AngularUniversalModule');\n\nfunction setupUniversal(app, ngOptions) {\n  const cacheOptions = getCacheOptions(ngOptions);\n  app.engine('html', (_, options, callback) => {\n    let cacheKey;\n\n    if (cacheOptions.isEnabled) {\n      const cacheKeyGenerator = cacheOptions.keyGenerator;\n      cacheKey = cacheKeyGenerator.generateCacheKey(options.req);\n      const cacheHtml = cacheOptions.storage.get(cacheKey);\n\n      if (cacheHtml) {\n        return callback(null, cacheHtml);\n      }\n    }\n\n    (0, express_engine_1.ngExpressEngine)({\n      bootstrap: ngOptions.bootstrap,\n      inlineCriticalCss: ngOptions.inlineCriticalCss,\n      providers: [{\n        provide: 'serverUrl',\n        useValue: `${options.req.protocol}://${options.req.get('host')}`\n      }, ...(ngOptions.extraProviders || [])]\n    })(_, options, (err, html) => {\n      if (err && ngOptions.errorHandler) {\n        return ngOptions.errorHandler({\n          err,\n          html,\n          renderCallback: callback\n        });\n      }\n\n      if (err) {\n        logger.error(err);\n        return callback(err);\n      }\n\n      if (cacheOptions.isEnabled && cacheKey) {\n        cacheOptions.storage.set(cacheKey, html, cacheOptions.expiresIn);\n      }\n\n      callback(null, html);\n    });\n  });\n  app.set('view engine', 'html');\n  app.set('views', ngOptions.viewsPath);\n  app.get(ngOptions.rootStaticPath, express.static(ngOptions.viewsPath, {\n    maxAge: 600\n  }));\n}\n\nexports.setupUniversal = setupUniversal;\n\nfunction getCacheOptions(ngOptions) {\n  if (!ngOptions.cache) {\n    return {\n      isEnabled: false\n    };\n  }\n\n  if (typeof ngOptions.cache !== 'object') {\n    return {\n      isEnabled: true,\n      storage: new in_memory_cache_storage_1.InMemoryCacheStorage(),\n      expiresIn: DEFAULT_CACHE_EXPIRATION_TIME,\n      keyGenerator: new cache_key_by_original_url_generator_1.CacheKeyByOriginalUrlGenerator()\n    };\n  }\n\n  return {\n    isEnabled: true,\n    storage: ngOptions.cache.storage || new in_memory_cache_storage_1.InMemoryCacheStorage(),\n    expiresIn: ngOptions.cache.expiresIn || DEFAULT_CACHE_EXPIRATION_TIME,\n    keyGenerator: ngOptions.cache.keyGenerator || new cache_key_by_original_url_generator_1.CacheKeyByOriginalUrlGenerator()\n  };\n}\n\nexports.getCacheOptions = getCacheOptions;","map":null,"metadata":{},"sourceType":"script"}